/** @module next-css-params
 *  @desc Generate & write scss config (file also will be used for sass-loader below, in `commonCssIncludesFiles`)...
 *  @since 2023.01.26, 18:09
 *  @changed 2023.10.06, 22:01
 *  @see:
 *  - source: `src/global/css-params-source.js`
 *  - generated scss: `src/global/css-params-generated.scss`
 *  - generated js: `src/global/css-params-generated.js`
 */

const path = require('path');
const fs = require('fs');

const prjPath = path.resolve(__dirname);
const srcPath = path.resolve(prjPath, 'src');

const cssParamsSourcePath = path.resolve(srcPath, 'core/global');
const generatedCssParamsPath = cssParamsSourcePath;
const cssProcessPath = path.resolve(cssParamsSourcePath, 'css-params-process');
const generatedCssParamsName = 'css-params-generated';
const generatedCssParamsScssFilename = generatedCssParamsName + '.scss';
const generatedCssParamsJsFilename = generatedCssParamsName + '.js';
const scssGeneratedConfigFile = path.resolve(
  generatedCssParamsPath,
  generatedCssParamsScssFilename,
);
const jsGeneratedConfigFile = path.resolve(generatedCssParamsPath, generatedCssParamsJsFilename);
const cssParamsSourceName = 'css-params-source.js';
const cssParamsSource = require(path.resolve(cssParamsSourcePath, cssParamsSourceName));
const { makeScssConfig, processCssConfigObject } = require(path.resolve(
  cssProcessPath,
  'css-process-routines.js',
));
const cssConfig = processCssConfigObject(cssParamsSource);
// const cssVersion = 'v.' + version + ' / ' + timestamp; // from build
const cssInfoStr = 'Generated by next.config from "' + cssParamsSourceName + '"'; // + ' for ' + cssVersion;
const scssGeneratedConfigContent = makeScssConfig(cssConfig, '// ' + cssInfoStr + '\n\n');
fs.writeFileSync(scssGeneratedConfigFile, scssGeneratedConfigContent);
const jsonData = { INFO: cssInfoStr, ...cssConfig };
const jsonStr = JSON.stringify(jsonData, null, 2);
const jsStr = 'export default ' + jsonStr.replace(/"([A-Za-z_]\w+)":/g, '$1:') + ';';
// fs.writeFileSync(jsonGeneratedConfigFile, jsonStr);
fs.writeFileSync(jsGeneratedConfigFile, jsStr);
// console.log('Generated', scssGeneratedConfigFile);

module.exports = {
  cssParamsSourcePath,
  generatedCssParamsPath,
  generatedCssParamsScssFilename,
  generatedCssParamsJsFilename,
};
